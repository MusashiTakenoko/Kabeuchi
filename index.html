<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>1on1çˆ†ä¸Šã’AIï½œChat</title>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      /* ===== ãƒ†ãƒ¼ãƒï¼ˆé»„ç·‘ï¼‰ ===== */
      --bg:#F7FFF7;
      --card:#FFFFFF;
      --line:#E6F7E6;
      --text:#173B1A;
      --muted:#6B8F6F;
      --pri:#65D96E;       /* ãƒ¡ã‚¤ãƒ³ï¼ˆé»„ç·‘ï¼‰ */
      --pri-600:#3FC755;   /* Hoveræ¿ƒè‰² */
      --pill:#ECFFEE;
      --shadow:0 8px 24px rgba(63,199,85,0.10);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:"M PLUS Rounded 1c", system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Yu Gothic UI", "Noto Sans JP", sans-serif;
      line-height:1.7;
    }
    header{
      position:sticky; top:0; z-index:10;
      background:#fff; border-bottom:1px solid var(--line);
      padding:12px 18px; display:flex; align-items:center; gap:12px; justify-content:space-between;
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    header img{ width:40px; height:40px; border-radius:50%; }
    header h1{ margin:0; font-size:20px; font-weight:800; letter-spacing:.02em;}
    header .lead{ margin:0; color:var(--muted); font-size:13px; }

    .wrap{ max-width:1100px; margin:0 auto; padding:20px 14px 26px; }

    .chat{
      background:var(--card); border:1px solid var(--line);
      border-radius:var(--radius); box-shadow:var(--shadow);
      display:flex; flex-direction:column; min-height:70vh; max-height:80vh;
    }
    .messages{
      padding:16px; overflow:auto; flex:1; display:flex; flex-direction:column; gap:14px;
      scroll-behavior:smooth;
    }
    .msg{ display:grid; grid-template-columns:42px 1fr; gap:10px; align-items:flex-start; }
    .avatar{
      width:42px; height:42px; border-radius:12px; display:grid; place-items:center;
      background:var(--pill); border:1px solid var(--line); font-size:20px; user-select:none;
    }
    .bubble{
      background:#FBFFFB; border:1px solid var(--line); padding:12px 14px; border-radius:14px;
      white-space:pre-wrap; word-wrap:break-word;
    }
    .msg.user .bubble{ background:#F4FFF5; border-color:#DCF6DE; }
    .msg.assistant .bubble{ background:#FFFFFF; }

    .composer{
      border-top:1px solid var(--line); padding:12px; display:flex; gap:10px; align-items:flex-end;
    }
    .composer textarea{
      flex:1; min-height:52px; max-height:200px; resize:vertical;
      width:100%; padding:12px 12px; border-radius:12px;
      border:1px solid var(--line); background:#fff; color:var(--text);
      outline:none;
    }
    .btn{
      border:0; border-radius:12px; padding:12px 16px; font-weight:800; cursor:pointer;
    }
    .btn-primary{ background:var(--pri); color:#fff; }
    .btn-primary:hover{ background:var(--pri-600); }
    .btn-ghost{ background:#F1FFF3; color:var(--pri-600); }
    .btn-danger{ background:#FFEBEB; color:#B23A3A; }

    .row{ display:flex; gap:8px; align-items:center; }
    .note{ font-size:12px; color:var(--muted); }
    .status.success{ color:#128A3F; }
    .status.error{ color:#B23A3A; }

    /* ãƒˆãƒ¼ã‚¹ãƒˆ */
    .toast{
      position:fixed; bottom:16px; left:50%; transform:translateX(-50%);
      background:#ffffff; border:1px solid var(--line); border-radius:999px;
      padding:8px 14px; font-size:12px; color:var(--muted); box-shadow:var(--shadow);
      display:none;
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="logomane.png" alt="logo" onerror="this.style.display='none'">
      <div>
        <h1>1on1çˆ†ä¸Šã’AI</h1>
        <p class="lead">Difyã‚¢ãƒ—ãƒªç”¨ï½œã‚ªãƒªã‚¸ãƒŠãƒ«Chat UI</p>
      </div>
    </div>
    <div class="row">
      <button class="btn btn-ghost" id="newChat" title="æ–°ã—ã„ä¼šè©±">ï¼‹ æ–°è¦</button>
    </div>
  </header>

  <main class="wrap">
    <section class="chat" aria-live="polite">
      <div id="messages" class="messages"></div>
      <div class="composer">
        <textarea id="input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ Enter ã§é€ä¿¡ï¼ˆæ”¹è¡Œã¯ Shift+Enterï¼‰"></textarea>
        <div class="row" style="flex-direction:column; align-items:stretch; gap:8px;">
          <button class="btn btn-primary" id="send">é€ä¿¡</button>
          <button class="btn btn-ghost" id="stop" disabled>åœæ­¢</button>
          <span id="status" class="note status">å¾…æ©Ÿä¸­</span>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <script>
    /**
     * ========= è¨­å®š =========
     * ã“ã“ã« Dify ã® App Key ã‚’è²¼ã‚Šä»˜ã‘ã¦é‹ç”¨ã—ã¦ãã ã•ã„ã€‚
     * ï¼ˆDifyã®ã€Œã‚¢ãƒ—ãƒªã€ç”»é¢ã§ç™ºè¡Œã™ã‚‹ **App Key**ã€‚API Keyã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰
     */
    const DIFY_APP_KEY = 'PASTE_YOUR_DIFY_APP_KEY_HERE'; // â†â˜…ã“ã“ã«ã‚­ãƒ¼ã‚’è²¼ã‚‹
    const DIFY_ENDPOINT = 'https://api.dify.ai/v1/chat-messages'; // Chatã‚¢ãƒ—ãƒªã®å ´åˆ
    const DEFAULT_USER_PREFIX = 'web';

    // ====== è¦ç´ ãƒ»çŠ¶æ…‹ ======
    const els = {
      messages: document.getElementById('messages'),
      input: document.getElementById('input'),
      send: document.getElementById('send'),
      stop: document.getElementById('stop'),
      status: document.getElementById('status'),
      newChat: document.getElementById('newChat'),
      toast: document.getElementById('toast'),
    };

    const LS = { convId: 'dify_conv_id', anon: 'anon_uid_v1' };
    function defaultUserId(){
      let v = localStorage.getItem(LS.anon);
      if(!v){ v = `${DEFAULT_USER_PREFIX}-` + Math.random().toString(36).slice(2,10); localStorage.setItem(LS.anon, v); }
      return v;
    }
    function getConvId(){ return localStorage.getItem(LS.convId) || ''; }
    function setConvId(id){ if(id){ localStorage.setItem(LS.convId, id); } }

    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    (function init(){
      renderMsg('assistant', 'ğŸ‘‹ ã¯ã˜ã‚ã¾ã—ã‚‡ã†ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦é€ä¿¡ã—ã¦ãã ã•ã„ã€‚');
      // Enteré€ä¿¡ï¼ˆShift+Enterã§æ”¹è¡Œï¼‰
      els.input.addEventListener('keydown', (e)=>{
        if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); safeSend(); }
      });
      // ã‚¯ãƒªãƒƒã‚¯é€ä¿¡
      els.send.addEventListener('click', safeSend);
      // åœæ­¢
      els.stop.addEventListener('click', stopStreaming);
      // æ–°è¦ä¼šè©±
      els.newChat.addEventListener('click', () => {
        localStorage.removeItem(LS.convId);
        renderMsg('assistant', 'ğŸ†• æ–°ã—ã„ä¼šè©±ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚');
        showToast('æ–°ã—ã„ä¼šè©±ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
      });
    })();

    // ====== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æç”» ======
    function renderMsg(role, text){
      const div = document.createElement('div');
      div.className = `msg ${role}`;
      div.innerHTML = `
        <div class="avatar">${role==='user'?'ğŸ§‘':'ğŸ¤–'}</div>
        <div class="bubble"></div>
      `;
      const bubble = div.querySelector('.bubble');
      bubble.textContent = text;
      els.messages.appendChild(div);
      els.messages.scrollTop = els.messages.scrollHeight;
      return bubble;
    }
    function appendChunk(bubble, chunk){
      bubble.textContent += chunk;
      els.messages.scrollTop = els.messages.scrollHeight;
    }

    // ====== ãƒˆãƒ¼ã‚¹ãƒˆ ======
    function showToast(text, ms=2200){
      els.toast.textContent = text;
      els.toast.style.display = 'block';
      setTimeout(()=> els.toast.style.display = 'none', ms);
    }

    // ====== é€ä¿¡åˆ¶å¾¡ ======
    let aborter = null;     // Streamingä¸­æ–­ç”¨
    let sending = false;    // äºŒé‡é€ä¿¡ã‚¬ãƒ¼ãƒ‰

    async function safeSend(){
      if(sending) return;   // äºŒé‡é€ä¿¡é˜²æ­¢
      const query = els.input.value.trim();
      if(!query) return;

      if(!DIFY_APP_KEY || DIFY_APP_KEY.includes('PASTE_YOUR_DIFY_APP_KEY_HERE')){
        renderMsg('assistant','âš ï¸ Dify App Key ãŒæœªè¨­å®šã§ã™ã€‚index.html å†…ã® DIFY_APP_KEY ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      sending = true;
      els.send.disabled = true; els.stop.disabled = false;
      els.status.textContent = 'é€ä¿¡ä¸­â€¦';

      // UIåæ˜ ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€ï¼‰
      renderMsg('user', query);
      els.input.value = '';

      const user = defaultUserId();
      const conversation_id = getConvId() || undefined;

      // å—ã‘å–ã‚Šãƒãƒ–ãƒ«
      const bubble = renderMsg('assistant','');

      // ã¾ãšã¯ Streaming ã‚’è©¦ã™ â†’ ãƒ€ãƒ¡ãªã‚‰ blocking ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      try{
        await callDifyStreaming({query, user, conversation_id, bubble});
        els.status.innerHTML = '<span class="status success">å®Œäº†</span>';
      }catch(streamErr){
        appendChunk(bubble, `\n\nâš ï¸ Streamingã«å¤±æ•—ã—ã¾ã—ãŸã€‚blockingãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚\nè©³ç´°: ${streamErr.message || streamErr}`);
        try{
          const answer = await callDifyBlocking({query, user, conversation_id});
          if(answer?.answer){ appendChunk(bubble, `\n\n${answer.answer}`); }
          if(answer?.conversation_id){ setConvId(answer.conversation_id); }
          els.status.innerHTML = '<span class="status success">å®Œäº†ï¼ˆblockingï¼‰</span>';
        }catch(blockErr){
          appendChunk(bubble, `\n\nâŒ é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ${blockErr.message || blockErr}`);
          els.status.innerHTML = '<span class="status error">ã‚¨ãƒ©ãƒ¼</span>';
        }
      }finally{
        sending = false;
        els.send.disabled = false; els.stop.disabled = true;
        aborter = null;
      }
    }

    function stopStreaming(){
      if(aborter){ aborter.abort(); els.stop.disabled = true; els.status.textContent = 'åœæ­¢ã—ã¾ã—ãŸ'; }
    }

    // ====== Difyå‘¼ã³å‡ºã—ï¼ˆStreamingï¼‰ ======
    async function callDifyStreaming({query, user, conversation_id, bubble}){
      aborter = new AbortController();
      const res = await fetch(DIFY_ENDPOINT, {
        method: 'POST',
        mode: 'cors',
        credentials: 'omit',
        headers: {
          'Authorization': 'Bearer ' + DIFY_APP_KEY,
          'Content-Type': 'application/json',
          'Accept': 'text/event-stream'
        },
        body: JSON.stringify({
          inputs: {},              // Appå…¥åŠ›ãŒã‚ã‚Œã°ã“ã“ã« { key:value }
          query,
          response_mode: 'streaming',
          user,
          conversation_id
        }),
        signal: aborter.signal
      });

      if(!res.ok || !res.body){
        const text = await res.text().catch(()=> '');
        throw new Error(`HTTP ${res.status}${text ? ' - ' + text : ''}`);
      }

      const reader = res.body.getReader();
      const decoder = new TextDecoder('utf-8');

      while(true){
        const {value, done} = await reader.read();
        if(done) break;
        const chunk = decoder.decode(value, {stream:true});
        for(const line of chunk.split(/\r?\n/)){
          if(!line.startsWith('data:')) continue;
          const data = line.slice(5).trim();
          if(!data || data === '[DONE]') continue;
          try{
            const evt = JSON.parse(data);
            switch(evt.event){
              case 'message':
                if(evt.answer){ appendChunk(bubble, evt.answer); }
                break;
              case 'message_end':
                if(evt.conversation_id){ setConvId(evt.conversation_id); }
                break;
              case 'error':
                throw new Error(evt?.message || 'unknown');
              default:
                // ping / tool_call ãªã©ã¯ä»Šå›ã¯ç„¡è¦–
                break;
            }
          }catch(e){
            // keep-aliveç­‰ã¯ç„¡è¦–
          }
        }
      }
    }

    // ====== Difyå‘¼ã³å‡ºã—ï¼ˆblocking ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ ======
    async function callDifyBlocking({query, user, conversation_id}){
      const res = await fetch(DIFY_ENDPOINT, {
        method: 'POST',
        mode: 'cors',
        credentials: 'omit',
        headers: {
          'Authorization': 'Bearer ' + DIFY_APP_KEY,
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({
          inputs: {},
          query,
          response_mode: 'blocking',
          user,
          conversation_id
        })
      });
      const text = await res.text();
      if(!res.ok){
        throw new Error(`HTTP ${res.status} - ${text}`);
      }
      try{
        return JSON.parse(text);
      }catch{
        return { answer: text };
      }
    }
  </script>
</body>
</html>
