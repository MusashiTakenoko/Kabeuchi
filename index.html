<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>1on1爆上げAI｜Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      /* ===== テーマ（黄緑） ===== */
      --bg:#F7FFF7;
      --card:#FFFFFF;
      --line:#E6F7E6;
      --text:#173B1A;
      --muted:#6B8F6F;
      --pri:#65D96E;       /* メイン（黄緑） */
      --pri-600:#3FC755;   /* Hover濃色 */
      --pill:#ECFFEE;
      --shadow:0 8px 24px rgba(63,199,85,0.10);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:"M PLUS Rounded 1c", system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Yu Gothic UI", "Noto Sans JP", sans-serif;
      line-height:1.7;
    }
    header{
      position:sticky; top:0; z-index:10;
      background:#fff; border-bottom:1px solid var(--line);
      padding:12px 18px; display:flex; align-items:center; gap:12px; justify-content:space-between;
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    header img{ width:40px; height:40px; border-radius:50%; }
    header h1{ margin:0; font-size:20px; font-weight:800; letter-spacing:.02em;}
    header .lead{ margin:0; color:var(--muted); font-size:13px; }

    .wrap{ max-width:1100px; margin:0 auto; padding:20px 14px 26px; }

    .chat{
      background:var(--card); border:1px solid var(--line);
      border-radius:var(--radius); box-shadow:var(--shadow);
      display:flex; flex-direction:column; min-height:70vh; max-height:80vh;
    }
    .messages{
      padding:16px; overflow:auto; flex:1; display:flex; flex-direction:column; gap:14px;
      scroll-behavior:smooth;
    }
    .msg{ display:grid; grid-template-columns:42px 1fr; gap:10px; align-items:flex-start; }
    .avatar{
      width:42px; height:42px; border-radius:12px; display:grid; place-items:center;
      background:var(--pill); border:1px solid var(--line); font-size:20px; user-select:none;
    }
    .bubble{
      background:#FBFFFB; border:1px solid var(--line); padding:12px 14px; border-radius:14px;
      white-space:pre-wrap; word-wrap:break-word;
    }
    .msg.user .bubble{ background:#F4FFF5; border-color:#DCF6DE; }
    .msg.assistant .bubble{ background:#FFFFFF; }

    .composer{
      border-top:1px solid var(--line); padding:12px; display:flex; gap:10px; align-items:flex-end;
    }
    .composer textarea{
      flex:1; min-height:52px; max-height:200px; resize:vertical;
      width:100%; padding:12px 12px; border-radius:12px;
      border:1px solid var(--line); background:#fff; color:var(--text);
      outline:none;
    }
    .btn{
      border:0; border-radius:12px; padding:12px 16px; font-weight:800; cursor:pointer;
    }
    .btn-primary{ background:var(--pri); color:#fff; }
    .btn-primary:hover{ background:var(--pri-600); }
    .btn-ghost{ background:#F1FFF3; color:var(--pri-600); }
    .btn-danger{ background:#FFEBEB; color:#B23A3A; }

    .row{ display:flex; gap:8px; align-items:center; }
    .note{ font-size:12px; color:var(--muted); }
    .status.success{ color:#128A3F; }
    .status.error{ color:#B23A3A; }

    /* トースト */
    .toast{
      position:fixed; bottom:16px; left:50%; transform:translateX(-50%);
      background:#ffffff; border:1px solid var(--line); border-radius:999px;
      padding:8px 14px; font-size:12px; color:var(--muted); box-shadow:var(--shadow);
      display:none;
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="logomane.png" alt="logo" onerror="this.style.display='none'">
      <div>
        <h1>1on1爆上げAI</h1>
        <p class="lead">Difyアプリ用｜オリジナルChat UI</p>
      </div>
    </div>
    <div class="row">
      <button class="btn btn-ghost" id="newChat" title="新しい会話">＋ 新規</button>
    </div>
  </header>

  <main class="wrap">
    <section class="chat" aria-live="polite">
      <div id="messages" class="messages"></div>
      <div class="composer">
        <textarea id="input" placeholder="メッセージを入力して Enter で送信（改行は Shift+Enter）"></textarea>
        <div class="row" style="flex-direction:column; align-items:stretch; gap:8px;">
          <button class="btn btn-primary" id="send">送信</button>
          <button class="btn btn-ghost" id="stop" disabled>停止</button>
          <span id="status" class="note status">待機中</span>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <script>
    /**
     * ========= 設定 =========
     * ここに Dify の App Key を貼り付けて運用してください。
     * （Difyの「アプリ」画面で発行する **App Key**。API Keyではありません）
     */
    const DIFY_APP_KEY = 'PASTE_YOUR_DIFY_APP_KEY_HERE'; // ←★ここにキーを貼る
    const DIFY_ENDPOINT = 'https://api.dify.ai/v1/chat-messages'; // Chatアプリの場合
    const DEFAULT_USER_PREFIX = 'web';

    // ====== 要素・状態 ======
    const els = {
      messages: document.getElementById('messages'),
      input: document.getElementById('input'),
      send: document.getElementById('send'),
      stop: document.getElementById('stop'),
      status: document.getElementById('status'),
      newChat: document.getElementById('newChat'),
      toast: document.getElementById('toast'),
    };

    const LS = { convId: 'dify_conv_id', anon: 'anon_uid_v1' };
    function defaultUserId(){
      let v = localStorage.getItem(LS.anon);
      if(!v){ v = `${DEFAULT_USER_PREFIX}-` + Math.random().toString(36).slice(2,10); localStorage.setItem(LS.anon, v); }
      return v;
    }
    function getConvId(){ return localStorage.getItem(LS.convId) || ''; }
    function setConvId(id){ if(id){ localStorage.setItem(LS.convId, id); } }

    // 初期メッセージ
    (function init(){
      renderMsg('assistant', '👋 はじめましょう。メッセージを入力して送信してください。');
      // Enter送信（Shift+Enterで改行）
      els.input.addEventListener('keydown', (e)=>{
        if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); safeSend(); }
      });
      // クリック送信
      els.send.addEventListener('click', safeSend);
      // 停止
      els.stop.addEventListener('click', stopStreaming);
      // 新規会話
      els.newChat.addEventListener('click', () => {
        localStorage.removeItem(LS.convId);
        renderMsg('assistant', '🆕 新しい会話を開始しました。');
        showToast('新しい会話を開始しました');
      });
    })();

    // ====== メッセージ描画 ======
    function renderMsg(role, text){
      const div = document.createElement('div');
      div.className = `msg ${role}`;
      div.innerHTML = `
        <div class="avatar">${role==='user'?'🧑':'🤖'}</div>
        <div class="bubble"></div>
      `;
      const bubble = div.querySelector('.bubble');
      bubble.textContent = text;
      els.messages.appendChild(div);
      els.messages.scrollTop = els.messages.scrollHeight;
      return bubble;
    }
    function appendChunk(bubble, chunk){
      bubble.textContent += chunk;
      els.messages.scrollTop = els.messages.scrollHeight;
    }

    // ====== トースト ======
    function showToast(text, ms=2200){
      els.toast.textContent = text;
      els.toast.style.display = 'block';
      setTimeout(()=> els.toast.style.display = 'none', ms);
    }

    // ====== 送信制御 ======
    let aborter = null;     // Streaming中断用
    let sending = false;    // 二重送信ガード

    async function safeSend(){
      if(sending) return;   // 二重送信防止
      const query = els.input.value.trim();
      if(!query) return;

      if(!DIFY_APP_KEY || DIFY_APP_KEY.includes('PASTE_YOUR_DIFY_APP_KEY_HERE')){
        renderMsg('assistant','⚠️ Dify App Key が未設定です。index.html 内の DIFY_APP_KEY を設定してください。');
        return;
      }

      sending = true;
      els.send.disabled = true; els.stop.disabled = false;
      els.status.textContent = '送信中…';

      // UI反映（ユーザー発言）
      renderMsg('user', query);
      els.input.value = '';

      const user = defaultUserId();
      const conversation_id = getConvId() || undefined;

      // 受け取りバブル
      const bubble = renderMsg('assistant','');

      // まずは Streaming を試す → ダメなら blocking にフォールバック
      try{
        await callDifyStreaming({query, user, conversation_id, bubble});
        els.status.innerHTML = '<span class="status success">完了</span>';
      }catch(streamErr){
        appendChunk(bubble, `\n\n⚠️ Streamingに失敗しました。blockingモードに切り替えます。\n詳細: ${streamErr.message || streamErr}`);
        try{
          const answer = await callDifyBlocking({query, user, conversation_id});
          if(answer?.answer){ appendChunk(bubble, `\n\n${answer.answer}`); }
          if(answer?.conversation_id){ setConvId(answer.conversation_id); }
          els.status.innerHTML = '<span class="status success">完了（blocking）</span>';
        }catch(blockErr){
          appendChunk(bubble, `\n\n❌ 送信に失敗しました: ${blockErr.message || blockErr}`);
          els.status.innerHTML = '<span class="status error">エラー</span>';
        }
      }finally{
        sending = false;
        els.send.disabled = false; els.stop.disabled = true;
        aborter = null;
      }
    }

    function stopStreaming(){
      if(aborter){ aborter.abort(); els.stop.disabled = true; els.status.textContent = '停止しました'; }
    }

    // ====== Dify呼び出し（Streaming） ======
    async function callDifyStreaming({query, user, conversation_id, bubble}){
      aborter = new AbortController();
      const res = await fetch(DIFY_ENDPOINT, {
        method: 'POST',
        mode: 'cors',
        credentials: 'omit',
        headers: {
          'Authorization': 'Bearer ' + DIFY_APP_KEY,
          'Content-Type': 'application/json',
          'Accept': 'text/event-stream'
        },
        body: JSON.stringify({
          inputs: {},              // App入力があればここに { key:value }
          query,
          response_mode: 'streaming',
          user,
          conversation_id
        }),
        signal: aborter.signal
      });

      if(!res.ok || !res.body){
        const text = await res.text().catch(()=> '');
        throw new Error(`HTTP ${res.status}${text ? ' - ' + text : ''}`);
      }

      const reader = res.body.getReader();
      const decoder = new TextDecoder('utf-8');

      while(true){
        const {value, done} = await reader.read();
        if(done) break;
        const chunk = decoder.decode(value, {stream:true});
        for(const line of chunk.split(/\r?\n/)){
          if(!line.startsWith('data:')) continue;
          const data = line.slice(5).trim();
          if(!data || data === '[DONE]') continue;
          try{
            const evt = JSON.parse(data);
            switch(evt.event){
              case 'message':
                if(evt.answer){ appendChunk(bubble, evt.answer); }
                break;
              case 'message_end':
                if(evt.conversation_id){ setConvId(evt.conversation_id); }
                break;
              case 'error':
                throw new Error(evt?.message || 'unknown');
              default:
                // ping / tool_call などは今回は無視
                break;
            }
          }catch(e){
            // keep-alive等は無視
          }
        }
      }
    }

    // ====== Dify呼び出し（blocking フォールバック） ======
    async function callDifyBlocking({query, user, conversation_id}){
      const res = await fetch(DIFY_ENDPOINT, {
        method: 'POST',
        mode: 'cors',
        credentials: 'omit',
        headers: {
          'Authorization': 'Bearer ' + DIFY_APP_KEY,
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({
          inputs: {},
          query,
          response_mode: 'blocking',
          user,
          conversation_id
        })
      });
      const text = await res.text();
      if(!res.ok){
        throw new Error(`HTTP ${res.status} - ${text}`);
      }
      try{
        return JSON.parse(text);
      }catch{
        return { answer: text };
      }
    }
  </script>
</body>
</html>
